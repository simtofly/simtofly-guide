# 1.5 Gazebo Simulation

## What You'll Learn

Add realistic 3D visualization to your drone simulations:
- ‚úÖ What Gazebo is and why we use it
- ‚úÖ Install Gazebo Harmonic
- ‚úÖ Install ArduPilot Gazebo plugin
- ‚úÖ Launch SITL with Gazebo visualization
- ‚úÖ Understand Gazebo interface
- ‚úÖ Control drone with 3D feedback
- ‚úÖ Verify physics simulation works

**Time:** 60-90 minutes

---

## Prerequisites

Before starting, you must have completed:
- ‚úÖ [1.1 Prerequisites and Setup](1.1-prerequisites.md)
- ‚úÖ [1.2 Environment Setup](1.2-environment-setup.md)
- ‚úÖ [1.3 ArduPilot SITL Installation](1.3-ardupilot-sitl.md)
- ‚úÖ [1.4 MAVProxy Command Line](1.4-mavproxy-basics.md)
- ‚úÖ SITL launches and accepts commands
- ‚úÖ Can control drone via MAVProxy

---

## ü§î What is Gazebo?

**Gazebo** = Advanced 3D robot simulator

It provides:
- **Realistic physics** ‚Äî Gravity, inertia, collisions
- **3D visualization** ‚Äî See your drone in realistic environment
- **Sensor simulation** ‚Äî Camera, GPS, IMU, lidar
- **Environmental factors** ‚Äî Wind, lighting, terrain

**Why add Gazebo to SITL?**

SITL alone:
- ‚ùå No visual feedback (just text/map)
- ‚ùå No realistic physics
- ‚ùå No sensor simulation

SITL + Gazebo:
- ‚úÖ See drone in 3D world
- ‚úÖ Realistic flight physics
- ‚úÖ Test sensors before real hardware
- ‚úÖ Better understanding of behavior

**Later (Phase 2):** We'll add ROS2 sensors in Gazebo.

---

## ÔøΩÔøΩ Install Gazebo Harmonic

### Why Gazebo Harmonic?

**Gazebo Harmonic** (released 2024) is recommended by ArduPilot:
- Latest stable release
- Best Ubuntu 22.04 support
- Active development and updates

**Alternative:** Gazebo Garden (LTS) ‚Äî Also works, but Harmonic is newer.

**Official guide:** https://gazebosim.org/docs/harmonic/install_ubuntu/

---

### Add Gazebo Repository
```bash
sudo wget https://packages.osrfoundation.org/gazebo.gpg -O /usr/share/keyrings/pkgs-osrf-archive-keyring.gpg
```
```bash
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/pkgs-osrf-archive-keyring.gpg] http://packages.osrfoundation.org/gazebo/ubuntu-stable $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/gazebo-stable.list > /dev/null
```

**What this does:** Adds official Gazebo package repository.

---

### Update Package List
```bash
sudo apt update
```

---

### Install Gazebo Harmonic
```bash
sudo apt install gz-harmonic -y
```

**What this installs:** Complete Gazebo Harmonic suite.

**This takes:** 5-10 minutes (downloads ~1-2GB).

**Expected output:**
```
Reading package lists... Done
Building dependency tree... Done
...
Setting up gz-harmonic...
```

‚úÖ **Success:** Installation completes without errors

---

### Verify Gazebo Installation
```bash
gz sim --version
```

**Expected output:**
```
Gazebo Sim, version 8.x.x
```

‚úÖ **Success:** Shows Gazebo Sim version 8.x (Harmonic)

---

### Test Gazebo Launch
```bash
gz sim
```

**What happens:**
- Gazebo window opens
- Shows empty world
- May take 10-20 seconds first launch

**If window opens:** ‚úÖ Gazebo installed correctly

**Close Gazebo:** File ‚Üí Exit (or Ctrl+C in terminal)

---

## üîå Install ArduPilot Gazebo Plugin

### What is the Plugin?

The **ArduPilot Gazebo plugin** connects:
- ArduPilot SITL ‚Üî Gazebo simulator
- Sends motor commands from ArduPilot to Gazebo
- Sends sensor data from Gazebo to ArduPilot

**Without plugin:** SITL and Gazebo can't communicate.

**Official guide:** https://ardupilot.org/dev/docs/ros2-gazebo.html

---

### Install Dependencies
```bash
sudo apt update
sudo apt install libgz-sim8-dev rapidjson-dev -y
```

**What these are:**
- `libgz-sim8-dev` ‚Äî Gazebo development libraries
- `rapidjson-dev` ‚Äî JSON parsing (for plugin)

---

### Clone ArduPilot Gazebo Plugin
```bash
cd ~/simtofly_ws
git clone https://github.com/ArduPilot/ardupilot_gazebo.git
```

**This takes:** 1-2 minutes.

---

### Build the Plugin
```bash
cd ~/simtofly_ws/ardupilot_gazebo
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo
make -j4
```

**Command breakdown:**
- `cmake ..` ‚Äî Configure build system
- `-DCMAKE_BUILD_TYPE=RelWithDebInfo` ‚Äî Optimized build with debug info
- `make -j4` ‚Äî Build using 4 CPU cores

**This takes:** 5-10 minutes.

**Expected output:**
```
-- Configuring done
-- Generating done
-- Build files written to: .../build
...
[100%] Built target ArduPilotPlugin
```

‚úÖ **Success:** Shows "Built target ArduPilotPlugin"

---

### Configure Environment Variables

Add plugin to Gazebo's search path:
```bash
echo 'export GZ_SIM_SYSTEM_PLUGIN_PATH=$HOME/simtofly_ws/ardupilot_gazebo/build:${GZ_SIM_SYSTEM_PLUGIN_PATH}' >> ~/.bashrc
```
```bash
echo 'export GZ_SIM_RESOURCE_PATH=$HOME/simtofly_ws/ardupilot_gazebo/models:$HOME/simtofly_ws/ardupilot_gazebo/worlds:${GZ_SIM_RESOURCE_PATH}' >> ~/.bashrc
```

**What these do:**
- First line: Tells Gazebo where to find the plugin
- Second line: Tells Gazebo where to find drone models and worlds

---

### Apply Changes
```bash
source ~/.bashrc
```

---

### Verify Environment Variables
```bash
echo $GZ_SIM_SYSTEM_PLUGIN_PATH
echo $GZ_SIM_RESOURCE_PATH
```

**Expected output:** Should show paths to your plugin directories.

‚úÖ **Success:** Paths displayed correctly

---

## üöÅ Launch SITL with Gazebo

### Start Gazebo First

Open **Terminal 1:**
```bash
gz sim -v4 -r iris_runway.sdf
```

**Command breakdown:**
- `gz sim` ‚Äî Launch Gazebo simulator
- `-v4` ‚Äî Verbose output (helpful for debugging)
- `-r` ‚Äî Run simulation immediately (not paused)
- `iris_runway.sdf` ‚Äî Quadcopter on runway world

**This takes:** 10-20 seconds to load.

**Expected result:**
- Gazebo window opens
- Shows runway environment
- Drone (iris quadcopter) visible on runway

‚úÖ **Success:** See drone in Gazebo world

---

### Start SITL

Open **Terminal 2** (keep Gazebo running):
```bash
cd ~/simtofly_ws/ardupilot/ardupilot/ArduCopter
sim_vehicle.py -v ArduCopter -f gazebo-iris --model JSON --map --console
```

**Command breakdown:**
- `-v ArduCopter` ‚Äî Vehicle type
- `-f gazebo-iris` ‚Äî Use Gazebo with iris model
- `--model JSON` ‚Äî Use JSON protocol for communication
- `--map` ‚Äî Open map window
- `--console` ‚Äî Open console window

**This takes:** 10-15 seconds.

**Expected output:**
```
Starting SITL...
Waiting for JSON sensor data...
Received sensor data from Gazebo
...
APM: ArduCopter V4.5.7
...
STABILIZE>
```

‚úÖ **Success:** Shows "Received sensor data from Gazebo" and `STABILIZE>` prompt

---

### Verify Connection

**In Gazebo window:**
- Drone should be sitting on runway
- Propellers visible

**In SITL console:**
- Shows flight mode (STABILIZE)
- GPS status should be good

**In map window:**
- Drone position displayed

‚úÖ **Success:** All windows show drone data

---

## üéÆ Test Flight in Gazebo

### Arm and Takeoff

In SITL terminal (Terminal 2):
```bash
mode GUIDED
arm throttle
takeoff 10
```

**Watch in Gazebo:**
- Propellers start spinning
- Drone lifts off ground
- Climbs to 10 meters
- Physics looks realistic (smooth acceleration)

**This takes:** 10-20 seconds to reach altitude.

‚úÖ **Success:** Drone flies in Gazebo, hovers at 10m

---

### Navigate in Gazebo

**Move forward (North):**
```bash
guided 20 0 -10
```

**Watch in Gazebo:**
- Drone tilts forward
- Moves to new position
- Realistic flight dynamics

---

### Land
```bash
land
```

**Watch in Gazebo:**
- Drone descends smoothly
- Touches down on runway
- Propellers stop spinning

‚úÖ **Success:** Complete flight in 3D simulation

---

## üé® Understanding Gazebo Interface

### Main Window Elements

**Top toolbar:**
- Play/Pause button ‚Äî Control simulation time
- Real-time factor ‚Äî Simulation speed (1.0 = real-time)
- Step button ‚Äî Advance one frame

**Left panel:**
- World tree ‚Äî List of objects in simulation
- Entity details ‚Äî Properties of selected object

**3D viewport:**
- Main visualization area
- Use mouse to navigate:
  - **Left-drag:** Rotate view
  - **Middle-drag:** Pan view
  - **Scroll:** Zoom in/out
  - **Shift+Left-drag:** Look around

**Right panel:**
- Component inspector ‚Äî Details of selected entity
- Can modify properties during simulation

---

### Useful View Controls

**Reset camera view:**
- Click on drone in left panel
- Press 'R' to focus camera on drone

**Toggle wireframe:**
- View ‚Üí Wireframe

**Show/hide panels:**
- Window ‚Üí Entity Tree
- Window ‚Üí Component Inspector

---

## üåç Different Gazebo Worlds

### Available Worlds

The plugin includes several environments:

**iris_runway.sdf** ‚Äî Drone on runway (default)
**iris_maze.sdf** ‚Äî Indoor maze environment  
**iris_warehouse.sdf** ‚Äî Indoor warehouse

---

### Launch Different World

**Example: Launch in warehouse:**

**Terminal 1:**
```bash
gz sim -v4 -r iris_warehouse.sdf
```

**Terminal 2:**
```bash
cd ~/simtofly_ws/ardupilot/ardupilot/ArduCopter
sim_vehicle.py -v ArduCopter -f gazebo-iris --model JSON --map --console
```

Try different worlds to test various scenarios!

---

## üìã Verification Checklist

Before moving to next section, verify:

- [ ] ‚úÖ Gazebo Harmonic installed (version 8.x)
- [ ] ‚úÖ ArduPilot Gazebo plugin built successfully
- [ ] ‚úÖ Environment variables set correctly
- [ ] ‚úÖ Gazebo launches with drone model
- [ ] ‚úÖ SITL connects to Gazebo (sees sensor data)
- [ ] ‚úÖ Can arm and takeoff in Gazebo
- [ ] ‚úÖ Drone physics looks realistic
- [ ] ‚úÖ Can navigate and land successfully
- [ ] ‚úÖ Understand Gazebo interface controls

**All checked?** You have complete 3D simulation! üöÄ

---

## üéØ What You Accomplished

- ‚úÖ Installed Gazebo Harmonic simulator
- ‚úÖ Built ArduPilot Gazebo plugin from source
- ‚úÖ Connected SITL to Gazebo
- ‚úÖ Launched drone in 3D environment
- ‚úÖ Performed flight with realistic physics
- ‚úÖ Learned Gazebo interface navigation
- ‚úÖ Tested different simulation worlds

---

## üöÄ Next Steps

Continue to **[1.6 First Autonomous Mission](1.6-first-mission.md)** where we'll:
- Create waypoint mission file
- Load mission into SITL
- Execute autonomous flight
- Analyze flight logs
- Complete Phase 1

---

## ‚ùì Common Questions

### Q: Gazebo Garden vs Gazebo Harmonic?

**A:** Both work with ArduPilot:
- **Harmonic** (recommended) ‚Äî Latest stable, best support
- **Garden** ‚Äî LTS release, more conservative choice

Stick with Harmonic unless you have specific issues.

---

### Q: Why build plugin from source instead of apt?

**A:** The ArduPilot Gazebo plugin isn't in Ubuntu repositories. Building from source ensures latest version and compatibility.

---

### Q: Gazebo is very slow/laggy

**A:** Solutions:
- Close other applications
- Reduce Gazebo quality: Edit ‚Üí Physics ‚Üí Real time factor
- Use simpler worlds (iris_runway instead of warehouse)
- Allocate more RAM to VM (if using VM)
- Consider native Ubuntu instead of VM

---

### Q: Can I use Gazebo with PX4 instead of ArduPilot?

**A:** Yes! Gazebo supports multiple autopilots. This tutorial focuses on ArduPilot, but Gazebo works with PX4, Betaflight, etc.

---

### Q: How do I add custom models to Gazebo?

**A:** Advanced topic ‚Äî Place models in `~/simtofly_ws/ardupilot_gazebo/models/` and they'll be available. We'll cover this in advanced tutorials.

---

## üêõ Troubleshooting

### Gazebo window doesn't open

**Cause:** Missing graphics libraries or GPU drivers

**Solution:**
```bash
sudo apt install libgl1-mesa-glx libglu1-mesa -y
```

Restart computer, try again.

---

### "Failed to load plugin" in Gazebo

**Cause:** Plugin not in Gazebo's search path

**Solution:**
```bash
# Verify environment variable
echo $GZ_SIM_SYSTEM_PLUGIN_PATH

# Should show path to your plugin

# If empty, re-add:
echo 'export GZ_SIM_SYSTEM_PLUGIN_PATH=$HOME/simtofly_ws/ardupilot_gazebo/build:${GZ_SIM_SYSTEM_PLUGIN_PATH}' >> ~/.bashrc
source ~/.bashrc
```

Restart Gazebo.

---

### SITL doesn't connect to Gazebo

**Cause:** Gazebo not running, or wrong model specified

**Solution:**
1. **Start Gazebo first** (Terminal 1)
2. Wait for world to fully load
3. **Then start SITL** (Terminal 2)
4. Verify `-f gazebo-iris` flag used

---

### "Could not find iris_runway.sdf"

**Cause:** GZ_SIM_RESOURCE_PATH not set

**Solution:**
```bash
echo 'export GZ_SIM_RESOURCE_PATH=$HOME/simtofly_ws/ardupilot_gazebo/models:$HOME/simtofly_ws/ardupilot_gazebo/worlds:${GZ_SIM_RESOURCE_PATH}' >> ~/.bashrc
source ~/.bashrc
```

---

### Build errors when compiling plugin

**Cause:** Missing dependencies

**Solution:**
```bash
sudo apt install libgz-sim8-dev rapidjson-dev cmake build-essential -y
```

Clean and rebuild:
```bash
cd ~/simtofly_ws/ardupilot_gazebo/build
rm -rf *
cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo
make -j4
```

---

### Drone falls through ground in Gazebo

**Cause:** Physics not initialized properly

**Solution:**
- Restart Gazebo
- Wait 2-3 seconds before launching SITL
- Check real-time factor (should be ~1.0)

---

### "JSON sensor timeout" error in SITL

**Cause:** SITL can't receive data from Gazebo

**Solution:**
1. Verify Gazebo is running first
2. Check drone model loaded in Gazebo
3. Restart both Gazebo and SITL in correct order

---

### Gazebo crashes on launch

**Cause:** GPU/graphics driver issues (common in VMs)

**Solution:**
- Update graphics drivers
- Try software rendering:
```bash
  export LIBGL_ALWAYS_SOFTWARE=1
  gz sim -v4 -r iris_runway.sdf
```
- Consider native Ubuntu for better GPU support

---

## üìö Additional Resources

**Official Documentation:**
- Gazebo Harmonic: https://gazebosim.org/docs/harmonic
- ArduPilot Gazebo: https://ardupilot.org/dev/docs/ros2-gazebo.html
- Gazebo Tutorials: https://gazebosim.org/docs/harmonic/tutorials

**Community:**
- ArduPilot Forums: https://discuss.ardupilot.org/
- Gazebo Community: https://community.gazebosim.org/

---

[‚Üê Back: 1.4 MAVProxy Basics](1.4-mavproxy-basics.md) | [Next: 1.6 First Autonomous Mission ‚Üí](1.6-first-mission.md)
