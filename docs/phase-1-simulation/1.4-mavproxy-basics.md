# 1.4 MAVProxy Command Line Control

## What You'll Learn

Master basic drone control through MAVProxy command line:

- ‚úÖ What MAVProxy is and why we use it
- ‚úÖ Launch SITL with map and console
- ‚úÖ Understand flight modes
- ‚úÖ Arm and disarm the vehicle
- ‚úÖ Perform takeoff and landing
- ‚úÖ Basic navigation using map
- ‚úÖ Monitor telemetry data

**Time:** 60-90 minutes

---

## Prerequisites

Before starting, you must have completed:

- ‚úÖ [1.1 Prerequisites and Setup](1.1-prerequisites.md)
- ‚úÖ [1.2 Environment Setup](1.2-environment-setup.md)
- ‚úÖ [1.3 ArduPilot SITL Installation](1.3-ardupilot-sitl.md)
- ‚úÖ SITL launches successfully
- ‚úÖ Can arm/disarm vehicle

---

## ü§î What is MAVProxy?

**MAVProxy** = MAVLink Proxy and Command Shell

It's a **command-line ground control station** that lets you:

- Control drone through typed commands
- Monitor telemetry in real-time
- Load and execute missions
- Visualize drone position on map

**Why MAVProxy?**

- Lightweight and fast
- Perfect for learning fundamentals
- Scriptable and automatable
- Works over SSH (no GUI needed)

**Later we'll use:** ROS2 for advanced control, but MAVProxy teaches the basics.

---

## üó∫Ô∏è Launch SITL with Map and Console

### Basic SITL Launch with Visualization

Instead of just text output, let's open map and console windows:

```bash
sim_vehicle.py -v ArduCopter --map --console
```

**Note:** We can run `sim_vehicle.py` from any directory because we added it to PATH in Section 1.3.

**Command breakdown:**

- `-v ArduCopter` ‚Äî Vehicle type (multirotor)
- `--map` ‚Äî Opens map window
- `--console` ‚Äî Opens console window

**This takes:** 10-20 seconds to launch all windows.

**Expected windows:**

1. **Terminal** ‚Äî SITL output and MAVProxy prompt
2. **Map window** ‚Äî Shows drone position on OpenStreetMap
3. **Console window** ‚Äî Shows telemetry data (altitude, speed, etc.)

‚úÖ **Success:** All three windows open, see `STABILIZE>` prompt

---

### Understanding the Windows

**Terminal (MAVProxy prompt):**
```
STABILIZE> 
```
This is where you type commands.

**Map window:**

- Blue icon = Drone position
- Green line = Drone heading
- Can zoom in/out (mouse wheel)
- Right-click for commands

**Console window:**

- Shows real-time data:

  - Mode, Armed status
  - Altitude, Speed
  - GPS status, Battery
  - Heading, Attitude

---

### Can't See Windows? (Headless/SSH Users)

If you're on SSH without display:

```bash
sim_vehicle.py -v ArduCopter
```

**Skip map/console** ‚Äî Control via terminal only (works fine for learning).

---

## üéÆ Understanding Flight Modes

ArduCopter has different modes for different purposes:

### Common Flight Modes

| Mode | Purpose | When to Use |
|------|---------|-------------|
| **STABILIZE** | Manual control, self-levels | Default mode, manual flying |
| **GUIDED** | Computer control via commands | Autonomous commands (takeoff, land) |
| **AUTO** | Follow pre-planned mission | Execute waypoint missions |
| **LOITER** | Hold position using GPS | Pause and hover in place |
| **CIRCLE** | Fly in circular pattern | Practice autonomous flight |
| **RTL** | Return to launch point | Emergency return home |
| **LAND** | Descend and land | Controlled landing |

**For this tutorial, we'll use:**

- `GUIDED` ‚Äî For takeoff and landing
- `LOITER` ‚Äî Hold position
- `CIRCLE` ‚Äî Fly in circles
- `RTL` ‚Äî Return home

---

### Check Current Mode

At MAVProxy prompt:

```bash
mode
```

**Expected output:**

```
STABILIZE
```

---

### Change Mode

```bash
mode GUIDED
```

**Expected output:**
```
GUIDED> 
```

Notice the prompt changes to show current mode.

‚úÖ **Success:** Mode changed, prompt shows `GUIDED>`

---

## ‚úàÔ∏è Arming and Takeoff

### Pre-Arm Checks

Before arming, ArduPilot performs safety checks:

- GPS lock (SITL has instant GPS)
- Battery sufficient
- No critical errors

In SITL, these pass automatically.

---

### Arm the Vehicle

**Switch to GUIDED mode first:**
```bash
mode GUIDED
```

**Then arm:**
```bash
arm throttle
```

**Expected output:**
```
ARMED
```

**Console window:** Shows "ARMED" status

**What happens:**

- Motors would spin up (if real drone)
- Vehicle ready to fly
- LEDs change (on real hardware)

‚úÖ **Success:** Status shows ARMED

---

### Important: 30-Second Rule

**After arming, you have 30 seconds to takeoff.**

If you don't send takeoff command within 30 seconds:

- Vehicle automatically disarms (safety feature)
- You'll see: `DISARMED`

**This prevents:** Leaving motors armed indefinitely.

---

### Takeoff Command

**Immediately after arming:**
```bash
takeoff 10
```

**Command breakdown:**

- `takeoff` ‚Äî Takeoff command
- `10` ‚Äî Target altitude in meters

**Expected behavior:**

- Drone climbs to 10 meters
- Console shows altitude increasing
- Map shows altitude number changing

**This takes:** 10-20 seconds to reach altitude.

**Watch console window:** Altitude (Alt) climbs to ~10m

‚úÖ **Success:** Altitude reaches 10 meters, drone hovers

---

## üß≠ Basic Navigation

### Navigate Using Map (Easiest Method)

After takeoff, the easiest way to move the drone:

1. **Right-click on the map** where you want drone to go
2. **Select "Fly to here"** from the menu
3. **Drone automatically flies** to that position and holds

**Practice:**

- Click different locations on the map
- Watch drone move in real-time
- Observe drone icon following your commands
- Map updates position continuously

‚úÖ **This is the recommended way for beginners!**

---

### Hold Position (LOITER Mode)

**To pause and hover in place:**

```bash
mode LOITER
rc 3 1500
```

**What happens:**

- Drone holds current GPS position
- Maintains altitude (with rc 3 1500)
- No drift (GPS position lock)

**Use this to:**

- Pause during flight
- Hold position while you plan next move
- Emergency "stop and hover"

**Note:** The `rc 3 1500` command sets throttle to maintain altitude in LOITER mode.

---

### Practice: Fly in Circles

**Make drone fly in circular pattern:**

```bash
mode GUIDED
arm throttle
takeoff 15

# Set throttle to maintain altitude
rc 3 1500

# Switch to CIRCLE mode
mode CIRCLE
```

**What happens:**

- Drone flies in circles around current center point
- Radius: 10 meters (default)
- Maintains 15m altitude (thanks to rc 3 1500)
- Direction: Clockwise

**Watch the map:** Drone traces circular path

**Return home:**
```bash
mode RTL
```

**Note:** The `rc 3 1500` command is necessary to maintain altitude in CIRCLE and LOITER modes. Without it, drone will lose altitude.

---

## üõ¨ Landing

### Land Command

When ready to land:
```bash
land
```

**What happens:**

- Drone descends at controlled rate
- Automatically disarms when on ground
- Mode changes to LAND

**This takes:** 10-30 seconds depending on altitude.

**Console window:** Watch altitude decrease to 0

‚úÖ **Success:** Altitude reaches 0, status shows DISARMED

---

### Alternative: RTL (Return to Launch)

**Return and land at start position:**
```bash
mode RTL
```

**What happens:**

- Drone flies back to start position
- Climbs to RTL altitude (15m default)
- Descends and lands at home

**Useful for:** Emergency return or end of mission.

---

## üìä Reading Telemetry

### Console Window Data

**Key information displayed:**

```
Mode: GUIDED
Armed: True
Alt: 10.5m
Spd: 2.3m/s
Hdg: 45¬∞
GPS: 3D Fix (10 sats)
Bat: 12.6V (100%)
```

**What each means:**

- **Mode** ‚Äî Current flight mode
- **Armed** ‚Äî Motors armed/disarmed
- **Alt** ‚Äî Altitude above ground
- **Spd** ‚Äî Ground speed
- **Hdg** ‚Äî Heading (0¬∞ = North)
- **GPS** ‚Äî GPS status and satellite count
- **Bat** ‚Äî Battery voltage and percentage

---

### MAVProxy Status Commands

**Get GPS position:**
```bash
status GPS_RAW_INT
```

**Get attitude (roll, pitch, yaw):**
```bash
status ATTITUDE
```

**Get battery status:**
```bash
status SYS_STATUS
```

---

## üéØ Complete Flight Example

Let's do a complete flight sequence:

### Step-by-Step Flight

```bash
# 1. Start SITL with map
sim_vehicle.py -v ArduCopter --map --console

# 2. Change to GUIDED mode
mode GUIDED

# 3. Arm the vehicle
arm throttle

# 4. Takeoff to 10 meters
takeoff 10

# Wait for altitude to reach 10m (watch console)

# 5. Navigate using map
# Right-click on map and select "Fly to here"
# Watch drone move to selected position

# 6. Try LOITER mode
mode LOITER
rc 3 1500

# 7. Try CIRCLE mode
mode CIRCLE

# Watch drone fly in circles

# 8. Return to launch
mode RTL

# Wait for drone to return and land

# 9. Exit SITL
Ctrl+C
```

**Complete this sequence** to verify everything works.

‚úÖ **Success:** Drone completes full flight, lands safely

---

## üåç Custom Location (Optional)

### Why Change Location?

Default SITL location is in Australia. You can set your own location.

---

### Add Custom Location

**Create location entry:**
```bash
echo "custom=YOUR_LAT,YOUR_LONG,ALT,HEADING" >> ~/simtofly_ws/ardupilot/Tools/autotest/locations.txt
```

**Example (replace with your coordinates):**
```bash
echo "myfield=37.7749,-122.4194,50,0" >> ~/simtofly_ws/ardupilot/Tools/autotest/locations.txt
```

**Format:**

- Name = your location identifier
- LAT = latitude (decimal degrees)
- LONG = longitude (decimal degrees)
- ALT = altitude MSL (meters)
- HEADING = initial heading (0 = North)

---

### Launch at Custom Location

```bash
sim_vehicle.py -v ArduCopter --map --console -L myfield
```

Replace `myfield` with your location name.

**Map window:** Shows your custom location.

---

## üìã Verification Checklist

Before moving to next section, verify:

- [ ] ‚úÖ Can launch SITL with `--map --console`
- [ ] ‚úÖ Map and console windows open
- [ ] ‚úÖ Can change flight modes (GUIDED, LOITER, CIRCLE)
- [ ] ‚úÖ Can arm vehicle (`arm throttle`)
- [ ] ‚úÖ Can takeoff to specific altitude
- [ ] ‚úÖ Can navigate using map "Fly to here"
- [ ] ‚úÖ Can use LOITER to hold position
- [ ] ‚úÖ Can use CIRCLE to fly in circles
- [ ] ‚úÖ Can land safely with RTL or land command
- [ ] ‚úÖ Understand telemetry data in console
- [ ] ‚úÖ Completed full flight sequence

**All checked?** You can control a simulated drone! üöÄ

---

## üéØ What You Accomplished

- ‚úÖ Launched SITL with visualization (map + console)
- ‚úÖ Understood different flight modes
- ‚úÖ Armed and disarmed vehicle
- ‚úÖ Performed takeoff to target altitude
- ‚úÖ Navigated drone using map interface
- ‚úÖ Used LOITER mode to hold position
- ‚úÖ Used CIRCLE mode for autonomous flight
- ‚úÖ Landed safely using RTL
- ‚úÖ Read and understood telemetry data
- ‚úÖ Completed full autonomous flight sequence

---

## üöÄ Next Steps

Continue to **[1.5 Gazebo Simulation](1.5-gazebo-simulation.md)** where we'll:

- Install Gazebo Harmonic 3D simulator
- Connect Gazebo to SITL
- See realistic drone physics
- Visualize sensors and environment

---

## ‚ùì Common Questions

### Q: Why use GUIDED mode instead of STABILIZE?

**A:** 

- **GUIDED** ‚Äî Accepts autonomous commands (takeoff, land)
- **STABILIZE** ‚Äî Manual RC control only (no autonomous commands)

For autonomous missions, always use GUIDED or AUTO.

---

### Q: What if I forget to takeoff within 30 seconds?

**A:** Vehicle disarms automatically. Just arm again and send takeoff command.

---

### Q: Can I control multiple drones in SITL?

**A:** Yes! Use multiple SITL instances on different ports. We'll cover this in advanced topics.

---

### Q: How do I make drone hold position?

**A:** Use one of these modes:

- **LOITER** with `rc 3 1500` ‚Äî Holds current GPS position
- **Map "Fly to here"** in GUIDED mode ‚Äî Holds at clicked position
- **STABILIZE** won't hold position (manual control only)

---

### Q: Why do CIRCLE and LOITER need rc 3 1500?

**A:** These modes need throttle input to maintain altitude. Without it, the drone will lose altitude. The `rc 3 1500` command sets throttle to middle position (hover).

---

### Q: How do I stop a command mid-flight?

**A:** Send a new command (overrides previous) or change mode:
```bash
mode LOITER  # Stops and holds position
```

---

## üêõ Troubleshooting

### Map window doesn't open

**Cause:** Missing Python packages

**Solution:**
```bash
pip3 install --user wxPython matplotlib
```

Relaunch SITL.

---

### "Bad mode" error when changing modes

**Cause:** Mode name typo

**Solution:** Mode names are case-sensitive. Use:

- `GUIDED` (not "guided")
- `STABILIZE` (not "stabilize")
- `LOITER` (not "loiter")

---

### Arm command rejected "PreArm: Need 3D Fix"

**Cause:** GPS not initialized (rare in SITL)

**Solution:** Wait 5-10 seconds, try arming again. SITL gets instant GPS fix.

---

### Console shows negative altitude

**Cause:** Normal! NED frame uses negative Z for up.

**Solution:** Nothing to fix. Just remember:

- Altitude 10m = Z of -10
- Ground level = Z of 0

---

### Takeoff command does nothing

**Cause:** 

1. Not armed
2. Not in GUIDED mode
3. Already in air

**Solution:**

```bash
mode GUIDED
arm throttle
takeoff 10
```

In this exact order.

---

### Drone loses altitude in CIRCLE or LOITER mode

**Cause:** Missing `rc 3 1500` command

**Solution:**
```bash
rc 3 1500
```

Then switch to CIRCLE or LOITER mode.

---

### "Failed to change mode" message

**Cause:** Some modes require certain conditions (e.g., GPS lock for LOITER)

**Solution:** Check console for reason, or use STABILIZE/GUIDED (always available).

---

[‚Üê Back: 1.3 ArduPilot SITL](1.3-ardupilot-sitl.md) | [Next: 1.5 Gazebo Simulation ‚Üí](1.5-gazebo-simulation.md)